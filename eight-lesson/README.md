# Восьмой урок

План урока
1. NDC понятие
2. Координатные системы
3. Локальное пространство
4. Мировое пространство
5. Пространство Вида
6. Пространство Отсечения
7. Ортографическая проекция
8. Перспетивная проекция
9. Переходим к 3D
10. Z-буфер

### 1)NDC понятие
**NDC** - нормализованные координаты устройства. OpenGL предполагает, что все вершины, которые мы увидем, после запуска шейдеров, будут нормализованы, то есть находиться в диапазоне от -1 до 1.Координаты вне этого диапазона видны не будут. Обычно мы указываем координаты в диапазоне, который настраиваем самостоятельно, а в вершинном шейдере преобразовываем эти координаты в NDC. Затем, эти NDC передаются растеризатору для преобразования их в двумерные координаты/пикселы вашего экрана.

### 2)Координатные системы
Преобразование координат в нормализованные, а затем в экранные координаты обычно осуществляется пошагово, и, до окончательного преобразования в экранные координаты, мы переводим вершины объекта в несколько координатных систем. Преимущество преобразования координат через несколько промежуточных координатных систем заключается в том, что некоторые операции/вычисления проще выполняются в определённых системах, и это скоро станет очевидно. Всего есть 5 различных координатных систем, которые для нас важны:
1. Локальное пространство (или пространство Объекта)
2. Мировое пространство
3. пространство Вида (или Наблюдателя)
4. пространство Отсечения
5. Экранное пространство

### Общая схема
Для преобразования координат из одного пространства в другое, мы будем использовать несколько матриц трансформации, среди которых, самыми важными являются матрицы Модели, Вида и Проекции. Координаты наших вершин начинаются в локальном пространстве как локальные координаты, и в дальнейшем преобразуются в мировые координаты, потом в координаты вида, отсечения, и, наконец, все заканчивается экранными координатами. Следующее изображение показывает эту последовательность, и то, что делает каждое преобразование:
![](https://hsto.org/files/ce9/dfc/577/ce9dfc577b9f4472beb14991182d6e1a.png)

1. Локальные координаты это координаты вашего объекта измеряемые относительно точки отсчета расположенной там, где начинается сам объект.
2. На следующем шаге локальные координаты преобразуются в координаты мирового пространства, которые по смыслу являются координатами более крупного мира. Эти координаты измеряются относительно глобальной точки отсчета, единой для всех других объектов расположенных в мировом пространстве.
3. Дальше мы трансформируем мировые координаты в координаты пространства Вида таким образом, что каждая вершина становится видна как бы на нее смотрели из камеры или с точки зрения наблюдателя.
4. После того, как координаты были преобразованы в пространство Вида, мы хотим спроецировать их в координаты Отсечения. Координаты Отсчения являются действительными в диапазоне от -1.0 до 1.0 и определяют, какие вершины появятся на экране.
5. И, наконец, в процессе преобразования, который мы назовем трансформацией области просмотра, мы преобразуем координаты отсечения от -1.0 до 1.0 в облась экранных координат заданную функцией glViewport.

После всего этого, полученные координаты отсылаются растеризатору для превращения их во фрагменты.

Причина, по которой мы преобразуем наши вершины в эти различные координатные пространства, заключается в том, что некоторые операции становятся более понятными или более простыми в определенных координатных системах.

Например, модификацию вашего объекта разумнее всего выполнять в локальном пространстве, а вычисление операций учитывающих расположение других объектов лучше делать в мировых координатах, и т.д. При желании мы могли бы задать одну матрицу трансформации, которая преобразовывала координаты из локального пространства в пространство Отсечения за один шаг, но это лишит нас гибкости.

### 3)Локальное пространство
Локальное пространство это координатная система, которая является локальной для объекта, то есть начинается в той же точке, что и сам объект. Представьте, что вы создали куб в программном пакете моделирования. Начальная точка вашего куба ерятно расположена в (0, 0, 0), даже несмотря на то, что куб в координатах приложения может находиться в другом месте. Возможно, что все созданные вами модели имеют начальную точку (0, 0, 0). Следовательно, все вершины вашей модели находятся в локальном пространстве: все их координаты являются локальными по отношению к вашему объекту.

Вершины контейнера, которым мы пользовались, были определены с координатами между -0.5 и 0.5 с начальной точкой отсчета в 0.0. Это локальные координаты.

### 4)Мировое пространство
Если мы напрямую импортируем все наши объекты в приложение, то они вероятно окажутся нагроможденными друг на друга около мировой точки отсчета (0, 0, 0), а это совсем не то, что мы хотим. Нам нужно определить положение каждого объекта для размещения их в более обширном пространстве. Координаты в мировом пространстве это как раз то, о чем говорит их название: координаты всех ваших вершин относительно мира. Это координатное пространство, в котором вы бы хотели видеть ваши объекты преобразованными таким образом, что бы они были распеределены в пространстве. Координаты вашего объекта преобразуются из локального в мировое пространство, это выполняется посредством матрицы модели.

Матрица модели это матрица, которая перемещает, масштабирует и/или вращает ваш объект для его расположения в мировом пространстве в позиции/ориентации в которой объект должен находиться.

### 5)Пространство Вида
Пространство Вида это то, что люди обычно называют камерой OpenGL. Пространство вида это результат преобразвания мировых координат в координаты, которые выглядят, как будто пользователь смотрит на них спереди. Таким образом пространство вида - это пространство видимое через видоискатель камеры. Это обычно достигается совокупностью таких сдвигов и вращений сцены, что некоторые объекты располагаются перед камерой. Эти комбинированные преобразования как правило хранятся в матрице вида, которая трансформирует мировые координаты в пространство вида.

### 6)Пространство Отсечения
После заверешения работы вершинных шейдеров, OpenGL ожидает, что все координаты будут в определенном диапазоне, а все что выходит за его границы будет отсчено. Отсеченные координаты отбрасываются, а оставшиеся становятся фрагментами, видимыми на экране.

Задавать все видимые координаты значениями из диапазона [-1.0, 1.0] на самом деле интуитивно непонятно, поэтому для работы мы определяем свой собственный набор координат и потом преобразовываем их обратно в NDC, как того ожидает OpenGL.

Для преобразования координат из пространства вида в пространство отсечения мы задаем так называемую матрицу проекции, которая определяет диапазон координат, например от -1000 до 1000 по каждой оси. Матрица проекции трансформирует координаты этого диапазона в нормализованные координаты устройства (-1.0, 1.0). Все координаты вне заданного нами промежутка не попадут в область [-1.0, 1.0], и, следовательно, будут отсечены. В том диапазоне, который мы задали матрицей проекции, координата (1250, 500, 750) не будет видна, так как её X-компонента выходит за границу, поэтому будет сконвертирована в значение, превышающее 1.0 в NDC, и, следовательно, вершина подвергнется отсечению.

Этот объем просмотра, задаваемый матрицей проекции, называется усечённой пирамидой (frustum) и каждая координата попадающая в эту пирамиду окажется и на экране пользователя. Весь процесс конвертации координат определенного диапазона в нормализованные координаты устройства (NDC), которые могут с легкостью отображены в двумерные координаты пространства вида, называется проецирование, так как матрица проекции проецирует 3D координаты на простые-для-преобразования-в-2D нормализованные координаты устройства.

Как только координаты всех вершин будут переведены в пространство отсечения, выполняется заключительная операция, называемая перспективное деление. В ней мы делим x,y и z компоненты вектора позиции вершины на гомогенную компоненту вектора w. Перспективное деление преобразует 4D координаты пространства отсечения в трехмерные нормализованные координаты устройства. Этот шаг выполняется автоматически после завершения работы каждого вершинного шейдера.

Именно после этого этапа, полученные координаты (используя установки glViewport) отображаются на координаты экрана и превращаются во фрагменты.

Матрица проекции преобразующая координаты вида в координаты отсечения может принимать две различных формы, и каждая форма определяет свою особенную усеченную пирамиду. Мы можем создать ортографическую матрицу проекции или перспективную.

### 7)Ортографическая проекция
